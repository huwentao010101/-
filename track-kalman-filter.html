<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>卡尔曼滤波轨迹数据可视化工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        accent: '#722ED1',
                        neutral: '#F2F3F5',
                        dark: '#1D2129',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                transition: all 0.3s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .slide-up {
                animation: slideUp 0.5s ease-out;
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-dark font-sans">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm fixed w-full top-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-line-chart text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">轨迹数据卡尔曼滤波工具</h1>
            </div>
            <nav>
                <ul class="flex space-x-6">
                    <li><a href="#demo" class="text-gray-600 hover:text-primary transition-colors">示例展示</a></li>
                    <li><a href="#upload" class="text-gray-600 hover:text-primary transition-colors">数据处理</a></li>
                    <li><a href="#about" class="text-gray-600 hover:text-primary transition-colors">关于工具</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 pt-24 pb-16">
        <!-- 欢迎部分 -->
        <section class="mb-16 text-center slide-up">
            <h2 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold mb-4">卡尔曼滤波轨迹数据平滑可视化</h2>
            <p class="text-gray-600 max-w-2xl mx-auto text-lg">
                本工具能够对轨迹数据进行噪声处理和可视化展示，通过卡尔曼滤波算法有效平滑轨迹数据，
                帮助您更清晰地分析运动轨迹特征。
            </p>
        </section>

        <!-- 示例展示部分 -->
        <section id="demo" class="mb-16 fade-in">
            <div class="bg-white rounded-xl p-6 md:p-8 card-shadow mb-8">
                <h3 class="text-xl md:text-2xl font-bold mb-6 flex items-center">
                    <i class="fa fa-play-circle text-primary mr-2"></i>
                    示例轨迹数据展示
                </h3>
                
                <div class="h-[400px] md:h-[500px] mb-6">
                    <canvas id="demoChart"></canvas>
                </div>
                
                <div class="flex flex-wrap gap-4 justify-center">
                    <button id="downloadTemplateBtn" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg flex items-center btn-hover">
                        <i class="fa fa-download mr-2"></i>
                        下载模板数据
                    </button>
                    <button id="regenerateDemoBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg flex items-center btn-hover">
                        <i class="fa fa-refresh mr-2"></i>
                        重新生成示例
                    </button>
                </div>
            </div>
        </section>

        <!-- 数据处理部分 -->
        <section id="upload" class="mb-16 fade-in">
            <div class="bg-white rounded-xl p-6 md:p-8 card-shadow">
                <h3 class="text-xl md:text-2xl font-bold mb-6 flex items-center">
                    <i class="fa fa-cogs text-primary mr-2"></i>
                    自定义轨迹数据处理
                </h3>
                
                <div class="grid md:grid-cols-12 gap-8">
                    <!-- 左侧控制面板 -->
                    <div class="md:col-span-4 space-y-6">
                        <!-- 上传数据 -->
                        <div class="p-5 border border-gray-200 rounded-lg">
                            <h4 class="font-semibold mb-4 text-gray-700">上传轨迹数据</h4>
                            <p class="text-sm text-gray-500 mb-4">请上传基于模板格式的CSV文件</p>
                            
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer" id="dropArea">
                                <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">拖放文件到此处或<span class="text-primary font-medium">点击上传</span></p>
                                <input type="file" id="fileInput" accept=".csv" class="hidden">
                            </div>
                            
                            <div id="fileInfo" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                        <span id="fileName" class="text-sm font-medium"></span>
                                    </div>
                                    <button id="removeFileBtn" class="text-gray-400 hover:text-red-500">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 滤波参数 -->
                        <div class="p-5 border border-gray-200 rounded-lg">
                            <h4 class="font-semibold mb-4 text-gray-700">卡尔曼滤波参数</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">过程噪声协方差 (Q)</label>
                                    <input type="number" id="processNoise" step="0.001" value="0.01" min="0.001" max="1" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">测量噪声协方差 (R)</label>
                                    <input type="number" id="measurementNoise" step="0.001" value="0.1" min="0.01" max="1" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">初始估计误差协方差 (P)</label>
                                    <input type="number" id="errorCovariance" step="0.01" value="1" min="0.1" max="10" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="flex flex-col gap-3">
                            <button id="processBtn" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg flex items-center justify-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-play mr-2"></i>
                                执行卡尔曼滤波
                            </button>
                            
                            <button id="downloadResultBtn" class="bg-accent hover:bg-accent/90 text-white px-6 py-3 rounded-lg flex items-center justify-center btn-hover hidden">
                                <i class="fa fa-download mr-2"></i>
                                下载滤波结果
                            </button>
                        </div>
                    </div>
                    
                    <!-- 右侧可视化区域 -->
                    <div class="md:col-span-8">
                        <div class="h-[400px] md:h-[500px] border border-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
                            <div id="noDataMessage" class="text-center p-8">
                                <i class="fa fa-file-text-o text-5xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500">请上传轨迹数据并点击"执行卡尔曼滤波"按钮</p>
                            </div>
                            <canvas id="resultChart" class="hidden w-full h-full"></canvas>
                        </div>
                        
                        <!-- 数据统计 -->
                        <div id="dataStats" class="hidden mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-neutral p-4 rounded-lg">
                                <h5 class="text-sm text-gray-500 mb-1">数据点数量</h5>
                                <p id="dataPointsCount" class="text-xl font-bold text-primary">-</p>
                            </div>
                            <div class="bg-neutral p-4 rounded-lg">
                                <h5 class="text-sm text-gray-500 mb-1">平均误差降低</h5>
                                <p id="errorReduction" class="text-xl font-bold text-secondary">-</p>
                            </div>
                            <div class="bg-neutral p-4 rounded-lg">
                                <h5 class="text-sm text-gray-500 mb-1">处理时间</h5>
                                <p id="processingTime" class="text-xl font-bold text-accent">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 关于部分 -->
        <section id="about" class="mb-16 fade-in">
            <div class="bg-white rounded-xl p-6 md:p-8 card-shadow">
                <h3 class="text-xl md:text-2xl font-bold mb-6 flex items-center">
                    <i class="fa fa-info-circle text-primary mr-2"></i>
                    关于卡尔曼滤波
                </h3>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <p class="text-gray-700 mb-4">
                            卡尔曼滤波是一种递归估计算法，能够从一系列包含统计噪声的测量数据中，
                            估计出系统的状态。它广泛应用于导航、控制、信号处理等领域。
                        </p>
                        <p class="text-gray-700 mb-4">
                            在轨迹平滑中，卡尔曼滤波能够有效去除测量噪声，同时保留轨迹的整体趋势和关键特征，
                            使轨迹更加平滑和易于分析。
                        </p>
                        <p class="text-gray-700">
                            本工具使用的是简化的一维和二维卡尔曼滤波模型，适用于大多数轨迹数据的平滑处理。
                            您可以通过调整滤波参数来获得最佳的平滑效果。
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold mb-3 text-gray-700">数据格式说明</h4>
                        <p class="text-gray-700 mb-3">上传的CSV文件应包含以下列（无表头）：</p>
                        <ul class="list-disc list-inside text-gray-700 space-y-1 mb-4">
                            <li>第一列：时间戳（可选）</li>
                            <li>第二列：X坐标</li>
                            <li>第三列：Y坐标</li>
                        </ul>
                        <p class="text-gray-700 text-sm bg-neutral p-3 rounded-lg">
                            示例：<br>
                            0,10.2,20.5<br>
                            1,11.3,21.1<br>
                            2,12.1,22.4<br>
                            ...
                        </p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center space-x-2">
                        <i class="fa fa-line-chart text-primary text-xl"></i>
                        <span class="font-bold">轨迹数据卡尔曼滤波工具</span>
                    </div>
                    <p class="text-gray-400 text-sm mt-2">高效的轨迹数据平滑与可视化解决方案</p>
                </div>
                
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-github text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-twitter text-xl"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fa fa-envelope text-xl"></i>
                    </a>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
                &copy; 2023 轨迹数据卡尔曼滤波工具 | 版权所有
            </div>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
        <i id="notificationIcon" class="mr-2"></i>
        <span id="notificationMessage"></span>
    </div>

    <script>
        // 卡尔曼滤波器类
        class KalmanFilter {
            constructor(processNoise = 0.01, measurementNoise = 0.1, errorCovariance = 1) {
                this.Q = processNoise;      // 过程噪声协方差
                this.R = measurementNoise;  // 测量噪声协方差
                this.P = errorCovariance;   // 估计误差协方差
                this.K = 0;                 // 卡尔曼增益
                this.x = null;              // 状态估计
            }
            
            // 初始化滤波器
            init(initialValue) {
                this.x = initialValue;
            }
            
            // 更新滤波器
            update(measurement) {
                if (this.x === null) {
                    this.init(measurement);
                    return measurement;
                }
                
                // 预测步骤
                // 状态预测：x = x_prev (因为我们假设系统模型是x_k = x_{k-1})
                // 误差协方差预测：P = P_prev + Q
                this.P += this.Q;
                
                // 更新步骤
                // 计算卡尔曼增益：K = P / (P + R)
                this.K = this.P / (this.P + this.R);
                
                // 更新状态估计：x = x + K*(z - x)
                this.x += this.K * (measurement - this.x);
                
                // 更新误差协方差：P = (1 - K)*P
                this.P = (1 - this.K) * this.P;
                
                return this.x;
            }
        }

        // 二维卡尔曼滤波器
        class KalmanFilter2D {
            constructor(processNoise = 0.01, measurementNoise = 0.1, errorCovariance = 1) {
                this.kfX = new KalmanFilter(processNoise, measurementNoise, errorCovariance);
                this.kfY = new KalmanFilter(processNoise, measurementNoise, errorCovariance);
            }
            
            update(x, y) {
                const filteredX = this.kfX.update(x);
                const filteredY = this.kfY.update(y);
                return { x: filteredX, y: filteredY };
            }
        }

        // 生成示例轨迹数据
        function generateDemoData(pointCount = 100, noiseLevel = 3) {
            const data = [];
            let x = 0;
            let y = 0;
            
            // 生成一个平滑的曲线（例如圆形轨迹）
            for (let i = 0; i < pointCount; i++) {
                const angle = (i / pointCount) * 2 * Math.PI * 2; // 两圈
                const radius = 50 + (i / pointCount) * 30; // 逐渐增大的半径
                
                // 基础轨迹（圆形）
                x = radius * Math.cos(angle);
                y = radius * Math.sin(angle);
                
                // 添加噪声
                const noisyX = x + (Math.random() - 0.5) * 2 * noiseLevel;
                const noisyY = y + (Math.random() - 0.5) * 2 * noiseLevel;
                
                data.push({
                    t: i,
                    x: x,
                    y: y,
                    noisyX: noisyX,
                    noisyY: noisyY
                });
            }
            
            return data;
        }

        // 应用卡尔曼滤波到轨迹数据
        function applyKalmanFilter(data, processNoise, measurementNoise, errorCovariance) {
            const kf = new KalmanFilter2D(processNoise, measurementNoise, errorCovariance);
            const filteredData = [];
            
            for (const point of data) {
                const filtered = kf.update(point.noisyX || point.x, point.noisyY || point.y);
                filteredData.push({
                    t: point.t,
                    x: filtered.x,
                    y: filtered.y
                });
            }
            
            return filteredData;
        }

        // 计算平均误差降低
        function calculateErrorReduction(originalData, filteredData, trueData) {
            let originalErrorSum = 0;
            let filteredErrorSum = 0;
            
            for (let i = 0; i < originalData.length; i++) {
                // 原始数据与真实数据的误差
                const origDx = originalData[i].x - trueData[i].x;
                const origDy = originalData[i].y - trueData[i].y;
                originalErrorSum += Math.sqrt(origDx * origDx + origDy * origDy);
                
                // 滤波后数据与真实数据的误差
                const filtDx = filteredData[i].x - trueData[i].x;
                const filtDy = filteredData[i].y - trueData[i].y;
                filteredErrorSum += Math.sqrt(filtDx * filtDx + filtDy * filtDy);
            }
            
            const originalAvgError = originalErrorSum / originalData.length;
            const filteredAvgError = filteredErrorSum / filteredData.length;
            
            // 计算误差降低百分比
            return ((originalAvgError - filteredAvgError) / originalAvgError) * 100;
        }

        // 解析CSV数据
        function parseCsvData(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                const parts = line.split(',').map(part => parseFloat(part.trim()));
                
                // 确保有至少x和y坐标
                if (parts.length >= 2) {
                    data.push({
                        t: parts.length >= 3 ? parts[0] : i,
                        x: parts.length >= 3 ? parts[1] : parts[0],
                        y: parts.length >= 3 ? parts[2] : parts[1],
                        // 对于用户上传的数据，原始数据就是带噪声的数据
                        noisyX: parts.length >= 3 ? parts[1] : parts[0],
                        noisyY: parts.length >= 3 ? parts[2] : parts[1]
                    });
                }
            }
            
            return data;
        }

        // 生成CSV数据
        function generateCsvData(data) {
            let csv = '';
            for (const point of data) {
                csv += `${point.t},${point.noisyX},${point.noisyY}\n`;
            }
            return csv;
        }

        // 下载文件
        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
            
            // 设置内容和样式
            messageEl.textContent = message;
            icon.className = isError ? 'fa fa-exclamation-circle text-red-500 mr-2' : 'fa fa-check-circle text-green-500 mr-2';
            notification.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center ${
                isError ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'
            }`;
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center';
            }, 3000);
        }

        // 初始化示例图表
        let demoChart;
        let resultChart;
        let demoData;
        let filteredDemoData;

        function initDemoChart() {
            // 生成示例数据
            demoData = generateDemoData();
            filteredDemoData = applyKalmanFilter(demoData, 0.01, 0.1, 1);
            
            const ctx = document.getElementById('demoChart').getContext('2d');
            
            // 如果图表已存在，销毁它
            if (demoChart) {
                demoChart.destroy();
            }
            
            // 创建新图表
            demoChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '真实轨迹',
                            data: demoData.map(p => ({ x: p.x, y: p.y })),
                            backgroundColor: 'rgba(54, 207, 201, 0.8)',
                            borderColor: 'rgba(54, 207, 201, 1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            showLine: true,
                            tension: 0.1
                        },
                        {
                            label: '带噪声轨迹',
                            data: demoData.map(p => ({ x: p.noisyX, y: p.noisyY })),
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            showLine: true,
                            tension: 0
                        },
                        {
                            label: '卡尔曼滤波后轨迹',
                            data: filteredDemoData.map(p => ({ x: p.x, y: p.y })),
                            backgroundColor: 'rgba(22, 93, 255, 0.8)',
                            borderColor: 'rgba(22, 93, 255, 1)',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            showLine: true,
                            tension: 0.1
                        }
                    ]
                },
                options: getChartOptions('示例轨迹数据：原始轨迹 vs 带噪声轨迹 vs 滤波后轨迹')
            });
        }

        // 获取图表配置选项
        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `X: ${context.parsed.x.toFixed(2)}, Y: ${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'X 坐标'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Y 坐标'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        min: -100,
                        max: 100
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };
        }

        // 初始化事件监听
        function initEventListeners() {
            // 下载模板数据
            document.getElementById('downloadTemplateBtn').addEventListener('click', () => {
                const csvData = generateCsvData(demoData);
                downloadFile(csvData, 'trajectory_template.csv', 'text/csv');
                showNotification('模板数据已下载');
            });
            
            // 重新生成示例数据
            document.getElementById('regenerateDemoBtn').addEventListener('click', () => {
                initDemoChart();
                showNotification('示例数据已重新生成');
            });
            
            // 文件上传区域
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const removeFileBtn = document.getElementById('removeFileBtn');
            const processBtn = document.getElementById('processBtn');
            
            // 点击上传区域触发文件选择
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 拖放功能
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('border-primary');
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('border-primary');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('border-primary');
                
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            // 文件选择变化
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    handleFileUpload(fileInput.files[0]);
                }
            });
            
            // 移除文件
            removeFileBtn.addEventListener('click', () => {
                fileInput.value = '';
                fileInfo.classList.add('hidden');
                processBtn.disabled = true;
                
                // 重置结果区域
                document.getElementById('noDataMessage').classList.remove('hidden');
                document.getElementById('resultChart').classList.add('hidden');
                document.getElementById('dataStats').classList.add('hidden');
                document.getElementById('downloadResultBtn').classList.add('hidden');
            });
            
            // 处理文件上传
            function handleFileUpload(file) {
                // 检查文件类型
                if (!file.name.endsWith('.csv')) {
                    showNotification('请上传CSV格式的文件', true);
                    return;
                }
                
                // 显示文件名
                fileName.textContent = file.name;
                fileInfo.classList.remove('hidden');
                processBtn.disabled = false;
                
                // 读取文件内容
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // 存储文件内容供后续处理
                        file.content = e.target.result;
                    } catch (error) {
                        showNotification('文件解析错误', true);
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }
            
            // 执行卡尔曼滤波
            let userData, filteredUserData;
            document.getElementById('processBtn').addEventListener('click', () => {
                if (!fileInput.files.length) {
                    showNotification('请先上传文件', true);
                    return;
                }
                
                try {
                    // 获取参数
                    const processNoise = parseFloat(document.getElementById('processNoise').value);
                    const measurementNoise = parseFloat(document.getElementById('measurementNoise').value);
                    const errorCovariance = parseFloat(document.getElementById('errorCovariance').value);
                    
                    // 解析数据
                    userData = parseCsvData(fileInput.files[0].content);
                    
                    if (userData.length < 2) {
                        showNotification('数据点太少，请提供更多数据', true);
                        return;
                    }
                    
                    // 记录处理开始时间
                    const startTime = performance.now();
                    
                    // 应用卡尔曼滤波
                    filteredUserData = applyKalmanFilter(userData, processNoise, measurementNoise, errorCovariance);
                    
                    // 计算处理时间
                    const processingTime = (performance.now() - startTime).toFixed(2);
                    
                    // 显示结果
                    document.getElementById('noDataMessage').classList.add('hidden');
                    const resultChartEl = document.getElementById('resultChart');
                    resultChartEl.classList.remove('hidden');
                    document.getElementById('dataStats').classList.remove('hidden');
                    document.getElementById('downloadResultBtn').classList.remove('hidden');
                    
                    // 更新统计信息
                    document.getElementById('dataPointsCount').textContent = userData.length;
                    document.getElementById('processingTime').textContent = `${processingTime} ms`;
                    
                    // 对于用户上传的数据，我们没有真实数据，所以无法计算误差降低
                    document.getElementById('errorReduction').textContent = 'N/A';
                    
                    // 绘制结果图表
                    const ctx = resultChartEl.getContext('2d');
                    
                    if (resultChart) {
                        resultChart.destroy();
                    }
                    
                    resultChart = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            datasets: [
                                {
                                    label: '原始轨迹',
                                    data: userData.map(p => ({ x: p.x, y: p.y })),
                                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1,
                                    pointRadius: 3,
                                    pointHoverRadius: 5,
                                    showLine: true,
                                    tension: 0
                                },
                                {
                                    label: '卡尔曼滤波后轨迹',
                                    data: filteredUserData.map(p => ({ x: p.x, y: p.y })),
                                    backgroundColor: 'rgba(22, 93, 255, 0.8)',
                                    borderColor: 'rgba(22, 93, 255, 1)',
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    pointHoverRadius: 5,
                                    showLine: true,
                                    tension: 0.1
                                }
                            ]
                        },
                        options: getChartOptions('轨迹数据处理结果：原始轨迹 vs 滤波后轨迹')
                    });
                    
                    showNotification('卡尔曼滤波处理完成');
                } catch (error) {
                    showNotification('处理数据时发生错误', true);
                    console.error(error);
                }
            });
            
            // 下载滤波结果
            document.getElementById('downloadResultBtn').addEventListener('click', () => {
                if (!filteredUserData || !userData) {
                    showNotification('没有可下载的结果数据', true);
                    return;
                }
                
                // 生成CSV数据
                let csv = '';
                for (let i = 0; i < filteredUserData.length; i++) {
                    csv += `${userData[i].t},${filteredUserData[i].x},${filteredUserData[i].y}\n`;
                }
                
                downloadFile(csv, 'filtered_trajectory.csv', 'text/csv');
                showNotification('滤波结果已下载');
            });
            
            // 滚动时导航栏效果
            window.addEventListener('scroll', () => {
                const header = document.querySelector('header');
                if (window.scrollY > 50) {
                    header.classList.add('py-2', 'shadow');
                    header.classList.remove('py-4');
                } else {
                    header.classList.add('py-4');
                    header.classList.remove('py-2', 'shadow');
                }
            });
            
            // 平滑滚动
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });
        }

        // 页面加载完成后初始化
        window.addEventListener('load', () => {
            initDemoChart();
            initEventListeners();
        });
    </script>
</body>
</html>
