<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轨迹数据异常点识别与修复</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        accent: '#722ED1',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                transition: all 0.3s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .slide-up {
                animation: slideUp 0.5s ease-out;
            }
            @keyframes slideUp {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm py-4">
        <div class="container mx-auto px-4">
            <div class="flex items-center space-x-2">
                <i class="fa fa-line-chart text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-primary">轨迹数据异常点识别与修复</h1>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl p-6 md:p-8 card-shadow slide-up">
            <p class="text-gray-600 mb-8">
                本工具可自动识别轨迹数据中的异常点，并使用线性插值方法修复这些异常点，使轨迹更加平滑合理。
                异常点通常表现为与相邻点距离过大、移动速度不合理的点。
            </p>
            
            <div class="grid md:grid-cols-12 gap-8">
                <!-- 左侧控制面板 -->
                <div class="md:col-span-4 space-y-6">
                    <!-- 上传数据 -->
                    <div class="p-5 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold mb-4 text-gray-700">上传轨迹数据</h4>
                        <p class="text-sm text-gray-500 mb-4">请上传可能包含异常点的CSV格式轨迹数据</p>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-warning transition-colors cursor-pointer" id="anomalyDropArea">
                            <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">拖放文件到此处或<span class="text-warning font-medium">点击上传</span></p>
                            <input type="file" id="anomalyFileInput" accept=".csv" class="hidden">
                        </div>
                        
                        <div id="anomalyFileInfo" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center">
                                    <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                    <span id="anomalyFileName" class="text-sm font-medium"></span>
                                </div>
                                <button id="anomalyRemoveFileBtn" class="text-gray-400 hover:text-red-500">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 生成带异常值的数据 -->
                    <div class="p-5 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold mb-4 text-gray-700">生成示例数据</h4>
                        <p class="text-sm text-gray-500 mb-4">生成包含异常点的示例轨迹数据</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">数据点数量</label>
                                <input type="number" id="anomalyPointCount" value="100" min="10" max="500" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-warning/50">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">异常点比例 (%)</label>
                                <input type="range" id="anomalyRatio" min="1" max="20" value="5" step="1"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-warning">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>1%</span>
                                    <span id="anomalyRatioValue">5%</span>
                                    <span>20%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">异常程度</label>
                                <input type="range" id="anomalySeverity" min="1" max="10" value="5" step="1"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-warning">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>轻微</span>
                                    <span id="anomalySeverityValue">5</span>
                                    <span>严重</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="generateAnomalyDataBtn" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center justify-center btn-hover">
                            <i class="fa fa-random mr-2"></i>
                            生成示例数据
                        </button>
                    </div>
                    
                    <!-- 异常检测参数 -->
                    <div class="p-5 border border-gray-200 rounded-lg">
                        <h4 class="font-semibold mb-4 text-gray-700">异常检测参数</h4>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">检测敏感度</label>
                                <input type="range" id="anomalySensitivity" min="1" max="10" value="5" step="1"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-warning">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>低 (少检测)</span>
                                    <span id="anomalySensitivityValue">5</span>
                                    <span>高 (多检测)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex flex-col gap-3">
                        <button id="processAnomalyBtn" class="bg-warning hover:bg-warning/90 text-white px-6 py-3 rounded-lg flex items-center justify-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-play mr-2"></i>
                            检测并修复异常
                        </button>
                        
                        <button id="downloadAnomalyResultBtn" class="bg-accent hover:bg-accent/90 text-white px-6 py-3 rounded-lg flex items-center justify-center btn-hover hidden">
                            <i class="fa fa-download mr-2"></i>
                            下载处理结果
                        </button>
                        
                        <button id="downloadAnomalyTemplateBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-3 rounded-lg flex items-center justify-center btn-hover">
                            <i class="fa fa-download mr-2"></i>
                            下载模板数据
                        </button>
                    </div>
                </div>
                
                <!-- 右侧可视化区域 -->
                <div class="md:col-span-8">
                    <div class="h-[400px] md:h-[500px] border border-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
                        <div id="anomalyNoDataMessage" class="text-center p-8">
                            <i class="fa fa-file-text-o text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">请上传数据或生成示例数据，然后点击"检测并修复异常"按钮</p>
                        </div>
                        <canvas id="anomalyDataChart" class="hidden w-full h-full"></canvas>
                    </div>
                    
                    <!-- 数据统计 -->
                    <div id="anomalyDataStats" class="hidden mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="text-sm text-gray-500 mb-1">数据点总数</h5>
                            <p id="anomalyTotalPoints" class="text-xl font-bold text-warning">-</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="text-sm text-gray-500 mb-1">检测到的异常点</h5>
                            <p id="anomalyDetectedCount" class="text-xl font-bold text-danger">-</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="text-sm text-gray-500 mb-1">处理时间</h5>
                            <p id="anomalyProcessingTime" class="text-xl font-bold text-accent">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>轨迹数据异常点识别与修复工具 &copy; 2023</p>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i id="notificationIcon" class="mr-2"></i>
        <span id="notificationMessage"></span>
    </div>

    <script>
        // 工具函数：下载文件
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        }

        // 异常检测与修复算法
        class AnomalyProcessor {
            /**
             * 检测并修复轨迹数据中的异常点
             * @param {Array} points - 轨迹点数组，每个点包含t(时间), x(x坐标), y(y坐标)
             * @param {number} sensitivity - 检测敏感度(1-10)，值越高检测越严格
             * @returns {Object} 包含处理后的数据和异常点数量的对象
             */
            static detectAndFixAnomalies(points, sensitivity = 5) {
                // 复制原始数据避免修改源数据
                const result = [...points.map(p => ({...p}))];
                let anomalyCount = 0;
                
                // 敏感度转换为阈值因子，值越高，阈值越低，检测越严格
                const thresholdFactor = 1.5 + (sensitivity - 1) * 0.5;
                
                // 计算每个点的速度（与前后点的距离除以时间差）
                const speeds = [];
                for (let i = 1; i < result.length - 1; i++) {
                    // 计算与前一点的距离
                    const prevDist = Math.hypot(
                        result[i].x - result[i-1].x,
                        result[i].y - result[i-1].y
                    );
                    // 计算与后一点的距离
                    const nextDist = Math.hypot(
                        result[i+1].x - result[i].x,
                        result[i+1].y - result[i].y
                    );
                    
                    // 计算时间差
                    const timeDiffPrev = result[i].t - result[i-1].t;
                    const timeDiffNext = result[i+1].t - result[i].t;
                    
                    // 避免除零错误
                    const speedPrev = timeDiffPrev > 0 ? prevDist / timeDiffPrev : 0;
                    const speedNext = timeDiffNext > 0 ? nextDist / timeDiffNext : 0;
                    
                    // 使用两点的平均速度
                    const speed = (speedPrev + speedNext) / 2;
                    speeds.push(speed);
                }
                
                // 计算速度阈值（使用中位数+中位数绝对偏差，更适合异常检测）
                if (speeds.length === 0) return { data: result, anomalyCount: 0 };
                
                // 排序用于计算中位数
                const sortedSpeeds = [...speeds].sort((a, b) => a - b);
                const medianIndex = Math.floor(sortedSpeeds.length / 2);
                const medianSpeed = sortedSpeeds[medianIndex];
                
                // 计算中位数绝对偏差
                const mad = sortedSpeeds.reduce((sum, s) => sum + Math.abs(s - medianSpeed), 0) / sortedSpeeds.length;
                
                // 计算阈值，使用修正后的公式更适合异常检测
                const speedThreshold = medianSpeed + mad * thresholdFactor;
                
                // 检测并修复异常点
                for (let i = 1; i < result.length - 1; i++) {
                    const prevDist = Math.hypot(
                        result[i].x - result[i-1].x,
                        result[i].y - result[i-1].y
                    );
                    const nextDist = Math.hypot(
                        result[i+1].x - result[i].x,
                        result[i+1].y - result[i].y
                    );
                    
                    const timeDiffPrev = result[i].t - result[i-1].t;
                    const timeDiffNext = result[i+1].t - result[i].t;
                    
                    // 避免除零错误
                    const speedPrev = timeDiffPrev > 0 ? prevDist / timeDiffPrev : 0;
                    const speedNext = timeDiffNext > 0 ? nextDist / timeDiffNext : 0;
                    const speed = (speedPrev + speedNext) / 2;
                    
                    // 判断是否为异常点
                    if (speed > speedThreshold) {
                        // 标记为异常点
                        result[i].isAnomaly = true;
                        anomalyCount++;
                        
                        // 使用线性插值修复异常点
                        const totalTime = timeDiffPrev + timeDiffNext;
                        const ratio = timeDiffPrev / totalTime;
                        
                        // 计算修复后的值
                        result[i].fixedX = result[i-1].x * (1 - ratio) + result[i+1].x * ratio;
                        result[i].fixedY = result[i-1].y * (1 - ratio) + result[i+1].y * ratio;
                        result[i].isFixed = true;
                    }
                }
                
                return { data: result, anomalyCount };
            }
        }

        // 数据生成器
        class DataGenerator {
            /**
             * 生成基础轨迹（圆形）
             * @param {number} pointCount - 数据点数量
             * @param {number} size - 轨迹大小
             * @returns {Array} 轨迹点数组
             */
            static generateBaseTrajectory(pointCount = 100, size = 50) {
                const data = [];
                
                for (let i = 0; i < pointCount; i++) {
                    // 生成圆形轨迹
                    const angle = (i / pointCount) * 2 * Math.PI * 2; // 两圈
                    const radius = size;
                    
                    const x = radius * Math.cos(angle);
                    const y = radius * Math.sin(angle);
                    
                    data.push({
                        t: i,
                        x: x,
                        y: y
                    });
                }
                
                return data;
            }
            
            /**
             * 生成带异常值的数据
             * @param {number} pointCount - 数据点数量
             * @param {number} anomalyRatio - 异常点比例(%)
             * @param {number} severity - 异常程度(1-10)
             * @returns {Object} 包含生成数据、真实数据和异常点数量的对象
             */
            static generateAnomalyData(pointCount = 100, anomalyRatio = 5, severity = 5) {
                const trueData = this.generateBaseTrajectory(pointCount);
                const anomalyCount = Math.floor(pointCount * (anomalyRatio / 100));
                const anomalyIndices = new Set();
                
                // 随机选择异常点（避免第一个和最后一个点）
                while (anomalyIndices.size < anomalyCount) {
                    const idx = Math.floor(Math.random() * pointCount);
                    if (idx > 0 && idx < pointCount - 1) {
                        anomalyIndices.add(idx);
                    }
                }
                
                // 创建带异常值的数据
                const result = trueData.map((point, i) => {
                    if (anomalyIndices.has(i)) {
                        // 根据严重程度添加异常值
                        const anomalyFactor = (severity / 5) * 3;
                        return {
                            t: point.t,
                            x: point.x + (Math.random() - 0.5) * 2 * anomalyFactor * 10,
                            y: point.y + (Math.random() - 0.5) * 2 * anomalyFactor * 10
                        };
                    }
                    return {...point};
                });
                
                return { data: result, trueData, anomalyCount };
            }
        }

        // CSV处理工具
        class CsvHandler {
            /**
             * 解析CSV数据
             * @param {string} csvText - CSV文本
             * @returns {Array} 解析后的轨迹点数组
             */
            static parse(csvText) {
                const lines = csvText.split('\n');
                const data = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    const parts = line.split(',').map(part => part.trim());
                    
                    // 确保有足够的数据
                    if (parts.length >= 3) {
                        data.push({
                            t: parseFloat(parts[0]),
                            x: parseFloat(parts[1]),
                            y: parseFloat(parts[2])
                        });
                    }
                }
                
                return data;
            }
            
            /**
             * 生成CSV数据
             * @param {Array} data - 轨迹点数组
             * @returns {string} CSV格式文本
             */
            static generate(data) {
                let csv = 't,x,y\n'; // 表头
                for (const point of data) {
                    // 使用修复后的值（如果有）
                    const x = point.isFixed ? point.fixedX : point.x;
                    const y = point.isFixed ? point.fixedY : point.y;
                    csv += `${point.t},${x.toFixed(4)},${y.toFixed(4)}\n`;
                }
                return csv;
            }
            
            /**
             * 生成模板数据
             * @param {number} pointCount - 数据点数量
             * @returns {string} CSV格式模板数据
             */
            static generateTemplate(pointCount = 100) {
                const data = DataGenerator.generateBaseTrajectory(pointCount);
                return this.generate(data);
            }
        }

        // 图表绘制工具
        class ChartHandler {
            /**
             * 绘制异常点检测与修复结果图表
             * @param {string} canvasId - canvas元素ID
             * @param {Array} originalData - 原始数据
             * @param {Array} processedData - 处理后的数据
             * @param {Array} trueData - 真实数据（可选）
             * @returns {Object} Chart.js图表实例
             */
            static drawAnomalyChart(canvasId, originalData, processedData, trueData = null) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                // 准备数据集
                const datasets = [];
                
                // 如果有真实数据，添加到图表
                if (trueData) {
                    datasets.push({
                        label: '真实轨迹',
                        data: trueData.map(p => ({ x: p.x, y: p.y })),
                        backgroundColor: 'rgba(54, 207, 201, 0.8)',
                        borderColor: 'rgba(54, 207, 201, 1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        showLine: true,
                        tension: 0.1,
                        order: 1
                    });
                }
                
                // 原始数据中的正常点
                const normalPoints = originalData.filter((_, i) => !processedData[i].isAnomaly);
                datasets.push({
                    label: '正常轨迹点',
                    data: normalPoints.map(p => ({ x: p.x, y: p.y })),
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    showLine: true,
                    tension: 0,
                    order: 2
                });
                
                // 原始数据中的异常点
                const anomalyPoints = processedData
                    .filter(p => p.isAnomaly)
                    .map(p => ({ x: p.x, y: p.y }));
                
                if (anomalyPoints.length > 0) {
                    datasets.push({
                        label: '检测到的异常点',
                        data: anomalyPoints,
                        backgroundColor: 'rgba(245, 63, 63, 0.8)',
                        borderColor: 'rgba(245, 63, 63, 1)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointStyle: 'star',
                        showLine: false,
                        order: 3
                    });
                }
                
                // 修复后的轨迹
                datasets.push({
                    label: '修复后轨迹',
                    data: processedData.map(p => ({ 
                        x: p.isFixed ? p.fixedX : p.x, 
                        y: p.isFixed ? p.fixedY : p.y 
                    })),
                    backgroundColor: 'rgba(22, 93, 255, 0.8)',
                    borderColor: 'rgba(22, 93, 255, 1)',
                    borderWidth: 2,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    showLine: true,
                    tension: 0.1,
                    order: 4
                });
                
                // 修复后的异常点
                const fixedPoints = processedData
                    .filter(p => p.isFixed)
                    .map(p => ({ x: p.fixedX, y: p.fixedY }));
                
                if (fixedPoints.length > 0) {
                    datasets.push({
                        label: '修复后的异常点',
                        data: fixedPoints,
                        backgroundColor: 'rgba(114, 46, 209, 0.8)',
                        borderColor: 'rgba(114, 46, 209, 1)',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointStyle: 'triangle',
                        showLine: false,
                        order: 5
                    });
                }
                
                return new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '轨迹异常点检测与修复结果',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 20
                                }
                            },
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `X: ${context.parsed.x.toFixed(2)}, Y: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'X 坐标'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                min: -120,
                                max: 120
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Y 坐标'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                min: -120,
                                max: 120
                            }
                        }
                    }
                });
            }
        }

        // 通知工具
        class NotificationHandler {
            /**
             * 显示通知消息
             * @param {string} message - 消息内容
             * @param {boolean} isError - 是否为错误消息
             */
            static show(message, isError = false) {
                const notification = document.getElementById('notification');
                const icon = document.getElementById('notificationIcon');
                const messageEl = document.getElementById('notificationMessage');
                
                // 设置内容和样式
                messageEl.textContent = message;
                icon.className = isError ? 'fa fa-exclamation-circle text-red-500 mr-2' : 'fa fa-check-circle text-green-500 mr-2';
                notification.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center z-50 ${
                    isError ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'
                }`;
                
                // 3秒后隐藏
                setTimeout(() => {
                    notification.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50';
                }, 3000);
            }
        }

        // 主控制器
        class AnomalyDetectionApp {
            constructor() {
                // 存储数据
                this.data = {
                    original: null,
                    processed: null,
                    trueData: null,
                    anomalyCount: 0
                };
                
                // 图表实例
                this.chart = null;
                
                // 初始化事件监听
                this.initEventListeners();
            }
            
            /**
             * 初始化事件监听器
             */
            initEventListeners() {
                const dropArea = document.getElementById('anomalyDropArea');
                const fileInput = document.getElementById('anomalyFileInput');
                const fileInfo = document.getElementById('anomalyFileInfo');
                const fileName = document.getElementById('anomalyFileName');
                const removeFileBtn = document.getElementById('anomalyRemoveFileBtn');
                const processBtn = document.getElementById('processAnomalyBtn');
                const generateBtn = document.getElementById('generateAnomalyDataBtn');
                const downloadTemplateBtn = document.getElementById('downloadAnomalyTemplateBtn');
                const downloadResultBtn = document.getElementById('downloadAnomalyResultBtn');
                
                // 异常比例滑块
                const anomalyRatio = document.getElementById('anomalyRatio');
                const anomalyRatioValue = document.getElementById('anomalyRatioValue');
                anomalyRatio.addEventListener('input', () => {
                    anomalyRatioValue.textContent = anomalyRatio.value;
                });
                
                // 异常程度滑块
                const anomalySeverity = document.getElementById('anomalySeverity');
                const anomalySeverityValue = document.getElementById('anomalySeverityValue');
                anomalySeverity.addEventListener('input', () => {
                    anomalySeverityValue.textContent = anomalySeverity.value;
                });
                
                // 检测敏感度滑块
                const anomalySensitivity = document.getElementById('anomalySensitivity');
                const anomalySensitivityValue = document.getElementById('anomalySensitivityValue');
                anomalySensitivity.addEventListener('input', () => {
                    anomalySensitivityValue.textContent = anomalySensitivity.value;
                });
                
                // 点击上传区域触发文件选择
                dropArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // 拖放功能
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('border-warning');
                });
                
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('border-warning');
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('border-warning');
                    
                    if (e.dataTransfer.files.length) {
                        this.handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
                
                // 文件选择变化
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length) {
                        this.handleFileUpload(fileInput.files[0]);
                    }
                });
                
                // 移除文件
                removeFileBtn.addEventListener('click', () => {
                    this.resetData();
                    fileInput.value = '';
                    fileInfo.classList.add('hidden');
                    processBtn.disabled = true;
                });
                
                // 生成示例数据
                generateBtn.addEventListener('click', () => {
                    const pointCount = parseInt(document.getElementById('anomalyPointCount').value);
                    const anomalyRatio = parseInt(document.getElementById('anomalyRatio').value);
                    const severity = parseInt(document.getElementById('anomalySeverity').value);
                    
                    const result = DataGenerator.generateAnomalyData(pointCount, anomalyRatio, severity);
                    
                    this.data.original = result.data;
                    this.data.trueData = result.trueData;
                    
                    // 显示文件信息
                    fileName.textContent = `生成的带异常数据 (${pointCount}点, 异常比例${anomalyRatio}%)`;
                    fileInfo.classList.remove('hidden');
                    processBtn.disabled = false;
                    
                    // 重置结果区域
                    this.resetResultDisplay();
                    
                    NotificationHandler.show(`已生成包含${result.anomalyCount}个异常点的示例数据`);
                });
                
                // 下载模板数据
                downloadTemplateBtn.addEventListener('click', () => {
                    const csvData = CsvHandler.generateTemplate(100);
                    downloadFile(csvData, 'trajectory_template.csv', 'text/csv');
                    NotificationHandler.show('轨迹数据模板已下载');
                });
                
                // 执行异常检测与修复
                processBtn.addEventListener('click', () => {
                    if (!this.data.original) {
                        NotificationHandler.show('没有可处理的数据，请先上传或生成数据', true);
                        return;
                    }
                    
                    try {
                        // 获取检测敏感度
                        const sensitivity = parseInt(document.getElementById('anomalySensitivity').value);
                        
                        // 记录处理开始时间
                        const startTime = performance.now();
                        
                        // 执行异常检测与修复
                        const result = AnomalyProcessor.detectAndFixAnomalies(
                            this.data.original,
                            sensitivity
                        );
                        
                        this.data.processed = result.data;
                        this.data.anomalyCount = result.anomalyCount;
                        
                        // 计算处理时间
                        const processingTime = (performance.now() - startTime).toFixed(2);
                        
                        // 显示结果
                        document.getElementById('anomalyNoDataMessage').classList.add('hidden');
                        document.getElementById('anomalyDataChart').classList.remove('hidden');
                        document.getElementById('anomalyDataStats').classList.remove('hidden');
                        document.getElementById('downloadAnomalyResultBtn').classList.remove('hidden');
                        
                        // 更新统计信息
                        document.getElementById('anomalyTotalPoints').textContent = this.data.original.length;
                        document.getElementById('anomalyDetectedCount').textContent = this.data.anomalyCount;
                        document.getElementById('anomalyProcessingTime').textContent = `${processingTime} ms`;
                        
                        // 绘制图表
                        if (this.chart) {
                            this.chart.destroy();
                        }
                        
                        this.chart = ChartHandler.drawAnomalyChart(
                            'anomalyDataChart',
                            this.data.original,
                            this.data.processed,
                            this.data.trueData
                        );
                        
                        NotificationHandler.show(`异常检测完成，共发现并修复${this.data.anomalyCount}个异常点`);
                    } catch (error) {
                        NotificationHandler.show('处理数据时发生错误', true);
                        console.error(error);
                    }
                });
                
                // 下载处理结果
                downloadResultBtn.addEventListener('click', () => {
                    if (!this.data.processed) {
                        NotificationHandler.show('没有可下载的结果数据', true);
                        return;
                    }
                    
                    const csvData = CsvHandler.generate(this.data.processed);
                    downloadFile(csvData, 'trajectory_anomalies_fixed.csv', 'text/csv');
                    NotificationHandler.show('异常点修复结果已下载');
                });
            }
            
            /**
             * 处理文件上传
             * @param {File} file - 上传的文件
             */
            handleFileUpload(file) {
                // 检查文件类型
                if (!file.name.endsWith('.csv')) {
                    NotificationHandler.show('请上传CSV格式的文件', true);
                    return;
                }
                
                // 读取文件内容
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        // 解析CSV数据
                        const data = CsvHandler.parse(e.target.result);
                        
                        if (data.length < 3) {
                            NotificationHandler.show('数据点太少，请提供至少3个数据点', true);
                            return;
                        }
                        
                        // 存储数据
                        this.data.original = data;
                        this.data.trueData = null; // 真实数据未知
                        
                        // 显示文件名
                        document.getElementById('anomalyFileName').textContent = `${file.name} (${data.length}个数据点)`;
                        document.getElementById('anomalyFileInfo').classList.remove('hidden');
                        document.getElementById('processAnomalyBtn').disabled = false;
                        
                        // 重置结果区域
                        this.resetResultDisplay();
                        
                        NotificationHandler.show(`文件上传成功，包含${data.length}个数据点`);
                    } catch (error) {
                        NotificationHandler.show('文件解析错误，请检查CSV格式', true);
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }
            
            /**
             * 重置数据
             */
            resetData() {
                this.data = {
                    original: null,
                    processed: null,
                    trueData: null,
                    anomalyCount: 0
                };
                
                this.resetResultDisplay();
                
                // 销毁图表
                if (this.chart) {
                    this.chart.destroy();
                    this.chart = null;
                }
            }
            
            /**
             * 重置结果显示区域
             */
            resetResultDisplay() {
                document.getElementById('anomalyNoDataMessage').classList.remove('hidden');
                document.getElementById('anomalyDataChart').classList.add('hidden');
                document.getElementById('anomalyDataStats').classList.add('hidden');
                document.getElementById('downloadAnomalyResultBtn').classList.add('hidden');
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new AnomalyDetectionApp();
        });
    </script>
</body>
</html>
