<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轨迹数据一致性检测与可视化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        warning: '#FF7D00',
                        danger: '#F53F3F',
                        success: '#00B42A',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-hover {
                transition: all 0.2s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(22, 93, 255, 0.2);
            }
            .fade-in {
                animation: fadeIn 0.5s ease-out forwards;
            }
            .slide-in {
                animation: slideIn 0.5s ease-out forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideIn {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm py-4 sticky top-0 z-10">
        <div class="container mx-auto px-4 md:px-6">
            <div class="flex items-center">
                <i class="fa fa-map-marker text-primary text-2xl mr-3"></i>
                <h1 class="text-xl md:text-2xl font-bold text-gray-800">轨迹数据一致性检测工具</h1>
                <span class="ml-3 text-sm bg-primary/10 text-primary px-3 py-1 rounded-full">位置与速度异常分析</span>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 md:px-6 py-8">
        <!-- 介绍卡片 -->
        <div class="bg-white rounded-xl p-6 mb-8 card-shadow slide-in">
            <h2 class="text-xl font-bold mb-3 text-gray-800">关于轨迹数据一致性检测</h2>
            <p class="text-gray-600">
                轨迹数据的一致性问题通常表现为位置的异常变化，如突然跳跃到另一个位置、速度不符合实际（如车辆突然以不可能的速度移动）等。
                本工具通过分析轨迹点之间的距离和速度变化，自动识别这些不一致性，并提供直观的可视化展示。
            </p>
        </div>
        
        <div class="grid md:grid-cols-3 gap-8">
            <!-- 左侧控制面板 -->
            <div class="md:col-span-1 space-y-6">
                <!-- 数据输入 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-database text-primary mr-2"></i>
                        数据输入
                    </h3>
                    
                    <!-- 上传区域 -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-5 text-center hover:border-primary transition-colors cursor-pointer mb-4" id="dropArea">
                        <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-2"></i>
                        <p class="text-gray-600">拖放CSV文件到此处或<span class="text-primary font-medium">点击上传</span></p>
                        <input type="file" id="fileInput" accept=".csv" class="hidden">
                    </div>
                    
                    <div id="fileInfo" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                <span id="fileName" class="text-sm font-medium"></span>
                            </div>
                            <button id="removeFileBtn" class="text-gray-400 hover:text-danger transition-colors">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 生成示例数据 -->
                    <button id="generateDataBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg flex items-center justify-center btn-hover">
                        <i class="fa fa-random mr-2"></i>
                        生成示例数据
                    </button>
                </div>
                
                <!-- 检测参数 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i>
                        检测参数
                    </h3>
                    
                    <div class="space-y-5">
                        <!-- 最大允许速度 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">最大允许速度 (单位: 距离/时间单位)</label>
                            <input type="number" id="maxSpeed" value="100" min="10" max="500" step="10"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50">
                            <p class="text-xs text-gray-500 mt-1">超过此速度的移动将被视为异常</p>
                        </div>
                        
                        <!-- 异常敏感度 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">异常敏感度</label>
                            <input type="range" id="sensitivity" min="1" max="10" value="5" step="1"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>低 (减少误报)</span>
                                <span id="sensitivityValue">5</span>
                                <span>高 (捕获更多异常)</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-cog text-primary mr-2"></i>
                        操作
                    </h3>
                    
                    <div class="space-y-3">
                        <button id="analyzeBtn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg flex items-center justify-center btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-search mr-2"></i>
                            分析轨迹一致性
                        </button>
                        
                        <button id="downloadBtn" class="w-full bg-success hover:bg-success/90 text-white py-3 px-4 rounded-lg flex items-center justify-center btn-hover hidden">
                            <i class="fa fa-download mr-2"></i>
                            下载分析结果
                        </button>
                        
                        <button id="downloadTemplateBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-4 rounded-lg flex items-center justify-center btn-hover">
                            <i class="fa fa-file-text-o mr-2"></i>
                            下载数据模板
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧可视化区域 -->
            <div class="md:col-span-2 space-y-6">
                <!-- 轨迹图 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-map text-primary mr-2"></i>
                        轨迹可视化
                    </h3>
                    
                    <div class="h-[400px] md:h-[500px] border border-gray-200 rounded-lg overflow-hidden">
                        <div id="noDataState" class="w-full h-full flex flex-col items-center justify-center text-center p-6">
                            <i class="fa fa-line-chart text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">请上传数据或生成示例数据，然后点击"分析轨迹一致性"按钮</p>
                        </div>
                        <canvas id="trajectoryChart" class="w-full h-full hidden"></canvas>
                    </div>
                </div>
                
                <!-- 时间-位置图 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-clock-o text-primary mr-2"></i>
                        时间-位置变化
                    </h3>
                    
                    <div class="h-[300px] border border-gray-200 rounded-lg overflow-hidden">
                        <div id="noTimePositionDataState" class="w-full h-full flex flex-col items-center justify-center text-center p-6">
                            <i class="fa fa-area-chart text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">分析后将显示随时间变化的位置图表</p>
                        </div>
                        <canvas id="timePositionChart" class="w-full h-full hidden"></canvas>
                    </div>
                </div>
                
                <!-- 异常点列表 -->
                <div class="bg-white rounded-xl p-5 card-shadow">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-exclamation-triangle text-warning mr-2"></i>
                        检测到的异常点
                    </h3>
                    
                    <div id="noAnomaliesState" class="w-full py-8 flex flex-col items-center justify-center text-center">
                        <i class="fa fa-check-circle text-4xl text-success/50 mb-4"></i>
                        <p class="text-gray-500">分析后将显示检测到的异常点</p>
                    </div>
                    
                    <div id="anomaliesList" class="hidden max-h-[300px] overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">时间点</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">位置 (X,Y)</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">异常类型</th>
                                    <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">速度</th>
                                </tr>
                            </thead>
                            <tbody id="anomaliesTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- 异常点数据将动态插入 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 md:px-6 text-center text-sm">
            <p>轨迹数据一致性检测工具 &copy; 2023</p>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i id="notificationIcon" class="mr-2"></i>
        <span id="notificationMessage"></span>
    </div>

    <script>
        // 工具类：通知处理
        class Notification {
            static show(message, isError = false) {
                const notification = document.getElementById('notification');
                const icon = document.getElementById('notificationIcon');
                const messageEl = document.getElementById('notificationMessage');
                
                messageEl.textContent = message;
                icon.className = isError ? 'fa fa-exclamation-circle text-red-500 mr-2' : 'fa fa-check-circle text-green-500 mr-2';
                
                notification.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center z-50 ${
                    isError ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'
                }`;
                
                // 3秒后隐藏
                setTimeout(() => {
                    notification.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50';
                }, 3000);
            }
        }

        // 工具类：文件处理
        class FileHandler {
            static download(content, filename, contentType) {
                const blob = new Blob([content], { type: contentType });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
            }
            
            static parseCSV(csvText) {
                const lines = csvText.split('\n');
                const data = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    const parts = line.split(',').map(part => part.trim());
                    
                    // 确保有足够的数据
                    if (parts.length >= 3) {
                        const t = parseFloat(parts[0]);
                        const x = parseFloat(parts[1]);
                        const y = parseFloat(parts[2]);
                        
                        if (!isNaN(t) && !isNaN(x) && !isNaN(y)) {
                            data.push({ t, x, y });
                        }
                    }
                }
                
                // 按时间排序
                data.sort((a, b) => a.t - b.t);
                return data;
            }
            
            static generateCSV(data) {
                let csv = 't,x,y,is_anomaly,anomaly_type,speed\n';
                
                for (const point of data) {
                    const isAnomaly = point.isAnomaly ? '1' : '0';
                    const anomalyType = point.anomalyType || '';
                    const speed = point.speed ? point.speed.toFixed(2) : '';
                    
                    csv += `${point.t},${point.x.toFixed(4)},${point.y.toFixed(4)},${isAnomaly},${anomalyType},${speed}\n`;
                }
                
                return csv;
            }
            
            static generateTemplate() {
                let csv = 't,x,y\n';
                // 生成示例数据，确保时间从1开始递增
                for (let i = 1; i <= 50; i++) {
                    const t = i;
                    const angle = (i / 50) * Math.PI * 2;
                    const x = Math.cos(angle) * 50;
                    const y = Math.sin(angle) * 50;
                    csv += `${t},${x.toFixed(4)},${y.toFixed(4)}\n`;
                }
                return csv;
            }
        }

        // 数据生成器 - 确保时间从1开始且明确
        class DataGenerator {
            static generateTrajectoryWithAnomalies(pointCount = 100, anomalyCount = 5) {
                const data = [];
                const anomalyIndices = new Set();
                
                // 生成基础圆形轨迹，时间从1开始，间隔1单位
                for (let i = 1; i <= pointCount; i++) {
                    const t = i;  // 时间从1开始，步长为1
                    const angle = (i / pointCount) * Math.PI * 4; // 两圈
                    const radius = 50 + Math.sin(i * 0.2) * 10; // 加入一些小波动
                    
                    const x = radius * Math.cos(angle);
                    const y = radius * Math.sin(angle);
                    
                    data.push({ t, x, y });
                }
                
                // 随机选择异常点
                while (anomalyIndices.size < anomalyCount) {
                    const idx = Math.floor(Math.random() * (pointCount - 1)) + 1; // 避免第一个点
                    anomalyIndices.add(idx);
                }
                
                // 添加异常
                anomalyIndices.forEach(idx => {
                    // 50%概率是位置跳跃，50%概率是速度异常
                    if (Math.random() < 0.5) {
                        // 位置跳跃异常
                        data[idx].x += (Math.random() - 0.5) * 100;
                        data[idx].y += (Math.random() - 0.5) * 100;
                    } else {
                        // 速度异常（下一个点）
                        if (idx < data.length - 1) {
                            data[idx + 1].x += (Math.random() - 0.5) * 80;
                            data[idx + 1].y += (Math.random() - 0.5) * 80;
                        }
                    }
                });
                
                return data;
            }
        }

        // 轨迹一致性分析器
        class TrajectoryAnalyzer {
            /**
             * 分析轨迹数据中的一致性问题
             * @param {Array} data - 轨迹点数组
             * @param {number} maxSpeed - 最大允许速度
             * @param {number} sensitivity - 敏感度(1-10)
             * @returns {Object} 分析结果
             */
            static analyze(data, maxSpeed, sensitivity) {
                if (data.length < 2) {
                    throw new Error('数据点太少，无法进行分析');
                }
                
                // 复制数据避免修改源数据
                const result = [...data.map(p => ({ ...p }))];
                const anomalies = [];
                
                // 计算敏感度因子
                const sensitivityFactor = 0.1 * (11 - sensitivity);
                
                // 计算每个点的速度和距离
                for (let i = 1; i < result.length; i++) {
                    const prev = result[i - 1];
                    const curr = result[i];
                    
                    // 计算时间差 - 确保时间差有效
                    const timeDiff = curr.t - prev.t;
                    if (timeDiff <= 0) {
                        // 处理无效时间差，设置一个合理的最小值
                        curr.speed = Infinity;
                        curr.isAnomaly = true;
                        curr.anomalyType = '时间异常';
                        
                        anomalies.push({
                            index: i,
                            t: curr.t,
                            x: curr.x,
                            y: curr.y,
                            speed: curr.speed,
                            distance: 0,
                            timeDiff: timeDiff,
                            type: '时间异常'
                        });
                        continue;
                    }
                    
                    // 计算距离
                    const distance = Math.hypot(curr.x - prev.x, curr.y - prev.y);
                    
                    // 计算速度
                    const speed = distance / timeDiff;
                    
                    // 存储速度信息
                    curr.speed = speed;
                    
                    // 检测速度异常
                    if (speed > maxSpeed) {
                        // 确定异常类型
                        let anomalyType = '';
                        if (distance > maxSpeed * timeDiff * 2) {
                            anomalyType = '位置跳跃';
                        } else {
                            anomalyType = '速度异常';
                        }
                        
                        // 标记当前点为异常
                        curr.isAnomaly = true;
                        curr.anomalyType = anomalyType;
                        
                        // 添加到异常列表
                        anomalies.push({
                            index: i,
                            t: curr.t,
                            x: curr.x,
                            y: curr.y,
                            speed: speed,
                            distance: distance,
                            timeDiff: timeDiff,
                            type: anomalyType
                        });
                    }
                }
                
                return {
                    processedData: result,
                    anomalies: anomalies,
                    totalPoints: result.length,
                    anomalyCount: anomalies.length,
                    maxSpeed: maxSpeed
                };
            }
        }

        // 图表绘制器
        class ChartDrawer {
            // 2D轨迹图
            static drawTrajectoryChart(canvasId, data, anomalies, maxSpeed) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                // 分离正常点和异常点
                const normalPoints = data.filter(p => !p.isAnomaly);
                const anomalyPoints = data.filter(p => p.isAnomaly);
                
                // 准备数据集
                const datasets = [
                    // 正常轨迹线
                    {
                        label: '正常轨迹',
                        data: normalPoints.map(p => ({ x: p.x, y: p.y })),
                        borderColor: 'rgba(22, 93, 255, 0.8)',
                        backgroundColor: 'rgba(22, 93, 255, 0.6)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        showLine: true,
                        tension: 0.1,
                        order: 1
                    },
                    // 异常点
                    {
                        label: '异常点',
                        data: anomalyPoints.map(p => ({ x: p.x, y: p.y })),
                        borderColor: 'rgba(245, 63, 63, 1)',
                        backgroundColor: 'rgba(245, 63, 63, 0.8)',
                        borderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointStyle: 'star',
                        showLine: false,
                        order: 2
                    }
                ];
                
                return new Chart(ctx, {
                    type: 'scatter',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `2D轨迹图 (最大允许速度: ${maxSpeed})`,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const index = context.dataIndex;
                                        const point = context.dataset.label === '正常轨迹' 
                                            ? normalPoints[index] 
                                            : anomalyPoints[index];
                                        
                                        let label = `时间: ${point.t}, 位置: (${point.x.toFixed(2)}, ${point.y.toFixed(2)})`;
                                        if (point.speed) {
                                            label += `, 速度: ${point.speed.toFixed(2)}`;
                                        }
                                        if (point.anomalyType) {
                                            label += `, 异常: ${point.anomalyType}`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'X 坐标'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Y 坐标'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }
            
            // 时间-位置变化图
            static drawTimePositionChart(canvasId, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                // 准备数据
                const timeData = data.map(p => p.t);
                const xData = data.map(p => ({x: p.t, y: p.x}));
                const yData = data.map(p => ({x: p.t, y: p.y}));
                
                // 准备数据集
                const datasets = [
                    {
                        label: 'X坐标随时间变化',
                        data: xData,
                        borderColor: 'rgba(22, 93, 255, 0.8)',
                        backgroundColor: 'rgba(22, 93, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        showLine: true,
                        tension: 0.1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Y坐标随时间变化',
                        data: yData,
                        borderColor: 'rgba(54, 207, 201, 0.8)',
                        backgroundColor: 'rgba(54, 207, 201, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        showLine: true,
                        tension: 0.1,
                        yAxisID: 'y1'
                    }
                ];
                
                return new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1000
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '位置随时间变化曲线',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `时间: ${context[0].raw.x.toFixed(1)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                // 强制X轴从实际最小时间开始
                                min: Math.min(...timeData) * 0.9,
                                max: Math.max(...timeData) * 1.1,
                                ticks: {
                                    stepSize: Math.max(1, Math.round((Math.max(...timeData) - Math.min(...timeData)) / 10))
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'X 坐标'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Y 坐标'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // 主应用控制器
        class TrajectoryConsistencyApp {
            constructor() {
                // 数据存储
                this.data = {
                    original: null,
                    processed: null,
                    anomalies: []
                };
                
                // 图表实例
                this.trajectoryChart = null;
                this.timePositionChart = null;
                
                // 初始化事件监听
                this.initEventListeners();
            }
            
            initEventListeners() {
                // 获取DOM元素
                const dropArea = document.getElementById('dropArea');
                const fileInput = document.getElementById('fileInput');
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const removeFileBtn = document.getElementById('removeFileBtn');
                const generateDataBtn = document.getElementById('generateDataBtn');
                const analyzeBtn = document.getElementById('analyzeBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
                const sensitivitySlider = document.getElementById('sensitivity');
                const sensitivityValue = document.getElementById('sensitivityValue');
                
                // 敏感度滑块
                sensitivitySlider.addEventListener('input', () => {
                    sensitivityValue.textContent = sensitivitySlider.value;
                });
                
                // 拖放区域点击触发文件选择
                dropArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // 拖放功能
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('border-primary');
                });
                
                dropArea.addEventListener('dragleave', () => {
                    dropArea.classList.remove('border-primary');
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('border-primary');
                    
                    if (e.dataTransfer.files.length) {
                        this.handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
                
                // 文件选择变化
                fileInput.addEventListener('change', () => {
                    if (fileInput.files.length) {
                        this.handleFileUpload(fileInput.files[0]);
                    }
                });
                
                // 移除文件
                removeFileBtn.addEventListener('click', () => {
                    this.resetData();
                    fileInput.value = '';
                    fileInfo.classList.add('hidden');
                    analyzeBtn.disabled = true;
                });
                
                // 生成示例数据
                generateDataBtn.addEventListener('click', () => {
                    const data = DataGenerator.generateTrajectoryWithAnomalies(100, 5);
                    this.data.original = data;
                    
                    fileName.textContent = `示例轨迹数据 (100个点, 时间从1到100)`;
                    fileInfo.classList.remove('hidden');
                    analyzeBtn.disabled = false;
                    
                    // 重置可视化区域
                    this.resetVisualizations();
                    
                    Notification.show('已生成包含异常的示例轨迹数据，时间从1开始');
                });
                
                // 分析轨迹数据
                analyzeBtn.addEventListener('click', () => {
                    if (!this.data.original) {
                        Notification.show('请先上传或生成轨迹数据', true);
                        return;
                    }
                    
                    try {
                        const maxSpeed = parseFloat(document.getElementById('maxSpeed').value);
                        const sensitivity = parseInt(document.getElementById('sensitivity').value);
                        
                        // 执行分析
                        const result = TrajectoryAnalyzer.analyze(
                            this.data.original,
                            maxSpeed,
                            sensitivity
                        );
                        
                        this.data.processed = result.processedData;
                        this.data.anomalies = result.anomalies;
                        
                        // 更新可视化
                        this.updateVisualizations(result);
                        
                        // 显示下载按钮
                        document.getElementById('downloadBtn').classList.remove('hidden');
                        
                        Notification.show(`分析完成，共检测到 ${result.anomalyCount} 个异常点`);
                    } catch (error) {
                        Notification.show(error.message, true);
                        console.error(error);
                    }
                });
                
                // 下载分析结果
                downloadBtn.addEventListener('click', () => {
                    if (!this.data.processed) {
                        Notification.show('没有可下载的分析结果', true);
                        return;
                    }
                    
                    const csvData = FileHandler.generateCSV(this.data.processed);
                    FileHandler.download(csvData, 'trajectory_analysis_result.csv', 'text/csv');
                    Notification.show('分析结果已下载');
                });
                
                // 下载数据模板
                downloadTemplateBtn.addEventListener('click', () => {
                    const template = FileHandler.generateTemplate();
                    FileHandler.download(template, 'trajectory_template.csv', 'text/csv');
                    Notification.show('数据模板已下载');
                });
            }
            
            handleFileUpload(file) {
                // 检查文件类型
                if (!file.name.endsWith('.csv')) {
                    Notification.show('请上传CSV格式的文件', true);
                    return;
                }
                
                // 读取文件内容
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = FileHandler.parseCSV(e.target.result);
                        
                        if (data.length < 2) {
                            Notification.show('数据点太少，请至少提供2个数据点', true);
                            return;
                        }
                        
                        // 检查是否有时间为0的数据点并修复
                        data.forEach((point, index) => {
                            if (point.t <= 0) {
                                point.t = index + 1; // 确保时间为正整数且递增
                            }
                        });
                        
                        // 重新排序以防时间顺序混乱
                        data.sort((a, b) => a.t - b.t);
                        
                        this.data.original = data;
                        
                        document.getElementById('fileName').textContent = `${file.name} (${data.length}个数据点, 时间范围: ${data[0].t.toFixed(1)} 至 ${data[data.length-1].t.toFixed(1)})`;
                        document.getElementById('fileInfo').classList.remove('hidden');
                        document.getElementById('analyzeBtn').disabled = false;
                        
                        // 重置可视化区域
                        this.resetVisualizations();
                        
                        Notification.show(`文件上传成功，包含 ${data.length} 个数据点`);
                    } catch (error) {
                        Notification.show('文件解析错误，请检查CSV格式', true);
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }
            
            resetData() {
                this.data = {
                    original: null,
                    processed: null,
                    anomalies: []
                };
                
                this.resetVisualizations();
                
                // 销毁图表
                if (this.trajectoryChart) {
                    this.trajectoryChart.destroy();
                    this.trajectoryChart = null;
                }
                
                if (this.timePositionChart) {
                    this.timePositionChart.destroy();
                    this.timePositionChart = null;
                }
            }
            
            resetVisualizations() {
                // 重置轨迹图
                document.getElementById('noDataState').classList.remove('hidden');
                document.getElementById('trajectoryChart').classList.add('hidden');
                
                // 重置时间-位置图
                document.getElementById('noTimePositionDataState').classList.remove('hidden');
                document.getElementById('timePositionChart').classList.add('hidden');
                
                // 重置异常点列表
                document.getElementById('noAnomaliesState').classList.remove('hidden');
                document.getElementById('anomaliesList').classList.add('hidden');
                document.getElementById('downloadBtn').classList.add('hidden');
            }
            
            updateVisualizations(analysisResult) {
                // 更新轨迹图
                document.getElementById('noDataState').classList.add('hidden');
                document.getElementById('trajectoryChart').classList.remove('hidden');
                
                if (this.trajectoryChart) {
                    this.trajectoryChart.destroy();
                }
                
                this.trajectoryChart = ChartDrawer.drawTrajectoryChart(
                    'trajectoryChart',
                    analysisResult.processedData,
                    analysisResult.anomalies,
                    analysisResult.maxSpeed
                );
                
                // 更新时间-位置图
                document.getElementById('noTimePositionDataState').classList.add('hidden');
                document.getElementById('timePositionChart').classList.remove('hidden');
                
                if (this.timePositionChart) {
                    this.timePositionChart.destroy();
                }
                
                this.timePositionChart = ChartDrawer.drawTimePositionChart(
                    'timePositionChart',
                    analysisResult.processedData
                );
                
                // 更新异常点列表
                const anomaliesTableBody = document.getElementById('anomaliesTableBody');
                anomaliesTableBody.innerHTML = '';
                
                if (analysisResult.anomalyCount > 0) {
                    document.getElementById('noAnomaliesState').classList.add('hidden');
                    document.getElementById('anomaliesList').classList.remove('hidden');
                    
                    analysisResult.anomalies.forEach((anomaly, index) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50 transition-colors';
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap text-sm">${index + 1}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">${anomaly.t.toFixed(1)}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                (${anomaly.x.toFixed(2)}, ${anomaly.y.toFixed(2)})
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                    ${anomaly.type}
                                </span>
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm">${anomaly.speed.toFixed(2)}</td>
                        `;
                        anomaliesTableBody.appendChild(row);
                    });
                } else {
                    document.getElementById('noAnomaliesState').classList.remove('hidden');
                    document.getElementById('anomaliesList').classList.add('hidden');
                    
                    // 更新无异常状态文本
                    document.querySelector('#noAnomaliesState p').textContent = '未检测到异常点，轨迹数据一致';
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new TrajectoryConsistencyApp();
        });
    </script>
</body>
</html>
