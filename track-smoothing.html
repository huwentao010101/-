<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轨迹数据平滑可视化工具（移动平均法）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',    // 主色调：蓝色
                        original: '#EF4444',   // 原始数据色：红色
                        smoothed: '#10B981',   // 平滑数据色：绿色
                        neutral: '#64748B',    // 中性色：灰色
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .btn-transition {
                transition: all 0.25s ease;
            }
            .btn-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(37, 99, 235, 0.15);
            }
            .input-focus:focus {
                outline: none;
                border-color: #2563EB;
                box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
            }
            .fade-in {
                animation: fadeIn 0.6s ease-out forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 md:px-6 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
                <div class="flex items-center">
                    <i class="fa fa-line-chart text-primary text-2xl mr-3"></i>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">轨迹数据平滑可视化工具</h1>
                    <span class="ml-3 text-sm bg-primary/10 text-primary px-3 py-1 rounded-full">移动平均法</span>
                </div>
                <div class="text-sm text-gray-500">
                    <i class="fa fa-info-circle mr-1"></i>
                    支持自定义窗口大小，实时对比原始与平滑轨迹
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="container mx-auto px-4 md:px-6 py-8">
        <!-- 介绍卡片 -->
        <div class="bg-white rounded-xl p-6 mb-8 card-shadow fade-in">
            <h2 class="text-xl font-bold mb-3 text-gray-800 flex items-center">
                <i class="fa fa-book text-primary mr-2"></i>
                移动平均法轨迹平滑原理
            </h2>
            <div class="text-gray-600 space-y-2">
                <p>移动平均法（Moving Average）是一种常用的时间序列数据平滑技术，通过计算固定窗口内数据点的平均值来减少噪声和异常值的影响。</p>
                <p class="font-medium">核心公式：</p>
                <p class="pl-6 italic">平滑后值 = (x<sub>i-n</sub> + x<sub>i-n+1</sub> + ... + x<sub>i</sub> + ... + x<sub>i+n</sub>) / (2n+1)</p>
                <p>其中 <span class="font-medium">2n+1</span> 为窗口大小，窗口越大平滑效果越强，但可能导致轨迹滞后；窗口越小平滑效果越弱，但能更好保留原始趋势。</p>
            </div>
        </div>
        
        <div class="grid md:grid-cols-3 gap-8">
            <!-- 左侧控制面板 -->
            <div class="md:col-span-1 space-y-6">
                <!-- 数据输入 -->
                <div class="bg-white rounded-xl p-5 card-shadow fade-in" style="animation-delay: 0.1s">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-database text-primary mr-2"></i>
                        数据输入
                    </h3>
                    
                    <!-- 上传区域 -->
                    <div id="dropArea" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer mb-4">
                        <i class="fa fa-cloud-upload text-3xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-2">拖放CSV文件到此处或<span class="text-primary font-medium">点击上传</span></p>
                        <p class="text-xs text-gray-500">CSV格式要求：时间(t),X坐标(x),Y坐标(y)，每行一个数据点</p>
                        <input type="file" id="fileInput" accept=".csv" class="hidden">
                    </div>
                    
                    <!-- 文件信息 -->
                    <div id="fileInfo" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <i class="fa fa-check-circle text-green-500 mr-2"></i>
                                <span id="fileName" class="text-sm font-medium"></span>
                            </div>
                            <button id="removeFileBtn" class="text-gray-400 hover:text-red-500 transition-colors">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 生成示例数据 -->
                    <button id="generateDataBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg flex items-center justify-center btn-transition btn-hover">
                        <i class="fa fa-random mr-2"></i>
                        生成带噪声的示例轨迹
                    </button>
                </div>
                
                <!-- 平滑参数 -->
                <div class="bg-white rounded-xl p-5 card-shadow fade-in" style="animation-delay: 0.2s">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-sliders text-primary mr-2"></i>
                        平滑参数设置
                    </h3>
                    
                    <div class="space-y-6">
                        <!-- 移动平均窗口大小 -->
                        <div>
                            <label for="windowSize" class="block text-sm font-medium text-gray-700 mb-2">
                                移动平均窗口大小
                            </label>
                            <div class="flex items-center gap-4">
                                <input type="range" id="windowSize" min="3" max="21" value="5" step="2"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                                <span id="windowSizeValue" class="min-w-[40px] text-center font-medium text-primary text-lg">5</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>小窗口 (3) - 保留细节</span>
                                <span>大窗口 (21) - 强平滑</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fa fa-lightbulb-o text-yellow-500 mr-1"></i>
                                建议值：3-11（奇数），窗口过大会导致轨迹严重滞后
                            </p>
                        </div>
                        
                        <!-- 时间间隔设置（仅示例数据） -->
                        <div>
                            <label for="timeInterval" class="block text-sm font-medium text-gray-700 mb-2">
                                示例数据时间间隔
                            </label>
                            <input type="number" id="timeInterval" value="1" min="0.1" max="5" step="0.1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md input-focus">
                            <p class="text-xs text-gray-500 mt-1">生成示例数据时使用的时间间隔（单位：秒）</p>
                        </div>
                        
                        <!-- 噪声强度（仅示例数据） -->
                        <div>
                            <label for="noiseLevel" class="block text-sm font-medium text-gray-700 mb-2">
                                示例数据噪声强度
                            </label>
                            <div class="flex items-center gap-4">
                                <input type="range" id="noiseLevel" min="1" max="20" value="5" step="1"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                                <span id="noiseLevelValue" class="min-w-[40px] text-center font-medium text-primary">5</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>低噪声</span>
                                <span>高噪声</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="bg-white rounded-xl p-5 card-shadow fade-in" style="animation-delay: 0.3s">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-cog text-primary mr-2"></i>
                        操作控制
                    </h3>
                    
                    <div class="space-y-3">
                        <button id="smoothBtn" class="w-full bg-primary hover:bg-primary/90 text-white py-3 px-4 rounded-lg flex items-center justify-center btn-transition btn-hover disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa fa-magic mr-2"></i>
                            执行轨迹平滑
                        </button>
                        
                        <button id="downloadRawBtn" class="w-full bg-original/10 hover:bg-original/20 text-original py-2.5 px-4 rounded-lg flex items-center justify-center btn-transition btn-hover hidden">
                            <i class="fa fa-download mr-2"></i>
                            下载原始数据
                        </button>
                        
                        <button id="downloadSmoothedBtn" class="w-full bg-smoothed/10 hover:bg-smoothed/20 text-smoothed py-2.5 px-4 rounded-lg flex items-center justify-center btn-transition btn-hover hidden">
                            <i class="fa fa-download mr-2"></i>
                            下载平滑后数据
                        </button>
                        
                        <button id="downloadTemplateBtn" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2.5 px-4 rounded-lg flex items-center justify-center btn-transition btn-hover">
                            <i class="fa fa-file-text-o mr-2"></i>
                            下载数据模板
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧可视化区域 -->
            <div class="md:col-span-2 space-y-6">
                <!-- 轨迹对比图 -->
                <div class="bg-white rounded-xl p-5 card-shadow fade-in" style="animation-delay: 0.1s">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4">
                        <h3 class="font-semibold text-lg flex items-center">
                            <i class="fa fa-map text-primary mr-2"></i>
                            原始轨迹 vs 平滑轨迹对比
                        </h3>
                        <div class="flex gap-3 mt-2 md:mt-0">
                            <div class="flex items-center text-sm">
                                <span class="w-3 h-3 rounded-full bg-original mr-2"></span>
                                <span>原始轨迹</span>
                            </div>
                            <div class="flex items-center text-sm">
                                <span class="w-3 h-3 rounded-full bg-smoothed mr-2"></span>
                                <span>平滑轨迹</span>
                            </div>
                            <div class="flex items-center text-sm">
                                <span class="w-3 h-3 rounded-full bg-neutral mr-2"></span>
                                <span>数据点</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="h-[450px] border border-gray-200 rounded-lg overflow-hidden">
                        <div id="noDataState" class="w-full h-full flex flex-col items-center justify-center text-center p-6">
                            <i class="fa fa-area-chart text-5xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 mb-2">请上传数据或生成示例数据</p>
                            <p class="text-gray-400 text-sm">然后点击"执行轨迹平滑"按钮查看结果</p>
                        </div>
                        <canvas id="trajectoryChart" class="w-full h-full hidden"></canvas>
                    </div>
                    
                    <!-- 平滑效果统计 -->
                    <div id="smoothStats" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mt-5">
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 mb-1">数据点总数</p>
                            <p id="totalPoints" class="text-lg font-semibold text-gray-800">0</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 mb-1">使用窗口大小</p>
                            <p id="usedWindowSize" class="text-lg font-semibold text-primary">0</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 mb-1">X轴平滑度</p>
                            <p id="xSmoothness" class="text-lg font-semibold text-smoothed">0.00%</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <p class="text-xs text-gray-500 mb-1">Y轴平滑度</p>
                            <p id="ySmoothness" class="text-lg font-semibold text-smoothed">0.00%</p>
                        </div>
                    </div>
                </div>
                
                <!-- X轴轨迹时间序列 -->
                <div class="bg-white rounded-xl p-5 card-shadow fade-in" style="animation-delay: 0.2s">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-clock-o text-primary mr-2"></i>
                        X轴坐标时间序列对比
                    </h3>
                    
                    <div class="h-[300px] border border-gray-200 rounded-lg overflow-hidden">
                        <div id="noXDataState" class="w-full h-full flex flex-col items-center justify-center text-center p-6">
                            <i class="fa fa-clock-o text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">执行平滑后将显示X轴时间序列</p>
                        </div>
                        <canvas id="xTimeSeriesChart" class="w-full h-full hidden"></canvas>
                    </div>
                </div>
                
                <!-- Y轴轨迹时间序列 -->
                <div class="bg-white rounded-xl p-5 card-shadow fade-in" style="animation-delay: 0.3s">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fa fa-clock-o text-primary mr-2"></i>
                        Y轴坐标时间序列对比
                    </h3>
                    
                    <div class="h-[300px] border border-gray-200 rounded-lg overflow-hidden">
                        <div id="noYDataState" class="w-full h-full flex flex-col items-center justify-center text-center p-6">
                            <i class="fa fa-clock-o text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">执行平滑后将显示Y轴时间序列</p>
                        </div>
                        <canvas id="yTimeSeriesChart" class="w-full h-full hidden"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 md:px-6 text-center text-sm">
            <p>轨迹数据平滑可视化工具 &copy; 2023 | 基于移动平均法实现</p>
        </div>
    </footer>

    <!-- 通知提示 -->
    <div id="notification" class="fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50">
        <i id="notificationIcon" class="mr-2"></i>
        <span id="notificationMessage"></span>
    </div>

    <script>
        // 全局数据存储
        const appData = {
            originalData: null,
            smoothedData: null,
            trajectoryChart: null,
            xTimeSeriesChart: null,
            yTimeSeriesChart: null
        };

        // DOM元素加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化事件监听
            initEventListeners();
        });

        // 初始化所有事件监听
        function initEventListeners() {
            // 窗口大小滑块
            const windowSizeSlider = document.getElementById('windowSize');
            const windowSizeValue = document.getElementById('windowSizeValue');
            windowSizeSlider.addEventListener('input', function() {
                windowSizeValue.textContent = this.value;
            });

            // 噪声强度滑块
            const noiseLevelSlider = document.getElementById('noiseLevel');
            const noiseLevelValue = document.getElementById('noiseLevelValue');
            noiseLevelSlider.addEventListener('input', function() {
                noiseLevelValue.textContent = this.value;
            });

            // 拖放区域事件
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            
            dropArea.addEventListener('click', () => {
                fileInput.click();
            });

            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('border-primary');
            });

            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('border-primary');
            });

            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('border-primary');
                
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            // 文件选择事件
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    handleFileUpload(this.files[0]);
                }
            });

            // 移除文件按钮
            document.getElementById('removeFileBtn').addEventListener('click', function() {
                resetData();
                fileInput.value = '';
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('smoothBtn').disabled = true;
            });

            // 生成示例数据按钮
            document.getElementById('generateDataBtn').addEventListener('click', function() {
                generateSampleData();
            });

            // 执行平滑按钮
            document.getElementById('smoothBtn').addEventListener('click', function() {
                applyMovingAverage();
            });

            // 下载按钮事件
            document.getElementById('downloadRawBtn').addEventListener('click', function() {
                downloadData(appData.originalData, '原始轨迹数据.csv');
            });

            document.getElementById('downloadSmoothedBtn').addEventListener('click', function() {
                if (appData.smoothedData) {
                    downloadData(appData.smoothedData, '平滑后轨迹数据.csv');
                }
            });

            document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
                downloadTemplate();
            });
        }

        // 生成示例数据
        function generateSampleData() {
            const pointCount = 100;
            const timeInterval = parseFloat(document.getElementById('timeInterval').value) || 1;
            const noiseLevel = parseInt(document.getElementById('noiseLevel').value) / 10;
            
            const data = [];
            let currentTime = 0;
            
            // 生成一个螺旋形轨迹作为基础
            for (let i = 0; i < pointCount; i++) {
                currentTime += timeInterval;
                const angle = (i / 20) * Math.PI;
                const radius = 5 + i * 0.5;
                
                // 基础坐标
                let x = radius * Math.cos(angle);
                let y = radius * Math.sin(angle);
                
                // 添加噪声
                x += (Math.random() - 0.5) * noiseLevel;
                y += (Math.random() - 0.5) * noiseLevel;
                
                data.push({ t: currentTime, x: x, y: y });
            }
            
            appData.originalData = data;
            
            // 更新UI
            document.getElementById('fileName').textContent = `示例轨迹数据 (${pointCount}个点)`;
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('smoothBtn').disabled = false;
            
            // 重置图表
            resetCharts();
            
            showNotification('已生成带噪声的示例轨迹数据');
        }

        // 处理文件上传
        function handleFileUpload(file) {
            if (!file.name.endsWith('.csv')) {
                showNotification('请上传CSV格式的文件', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = parseCSV(e.target.result);
                    
                    if (data.length < 3) {
                        showNotification('数据点太少，请至少提供3个数据点', true);
                        return;
                    }
                    
                    appData.originalData = data;
                    
                    document.getElementById('fileName').textContent = `${file.name} (${data.length}个数据点)`;
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('smoothBtn').disabled = false;
                    
                    // 重置图表
                    resetCharts();
                    
                    showNotification(`文件上传成功，包含 ${data.length} 个数据点`);
                } catch (error) {
                    showNotification(`文件解析错误: ${error.message}`, true);
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // 解析CSV数据
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                const parts = line.split(',').map(part => part.trim());
                
                if (parts.length >= 3) {
                    const t = parseFloat(parts[0]);
                    const x = parseFloat(parts[1]);
                    const y = parseFloat(parts[2]);
                    
                    if (!isNaN(t) && !isNaN(x) && !isNaN(y)) {
                        data.push({ t, x, y });
                    } else {
                        throw new Error(`第 ${i+1} 行包含无效数值`);
                    }
                } else {
                    throw new Error(`第 ${i+1} 行格式不正确，需要至少3列数据`);
                }
            }
            
            // 按时间排序
            data.sort((a, b) => a.t - b.t);
            return data;
        }

        // 应用移动平均法平滑数据
        function applyMovingAverage() {
            if (!appData.originalData) return;
            
            const windowSize = parseInt(document.getElementById('windowSize').value);
            const n = Math.floor(windowSize / 2); // 窗口半径
            const data = appData.originalData;
            const smoothed = [];
            
            // 对每个点应用移动平均
            for (let i = 0; i < data.length; i++) {
                // 确定窗口范围（处理边界情况）
                const start = Math.max(0, i - n);
                const end = Math.min(data.length - 1, i + n);
                
                // 计算窗口内的平均值
                let sumX = 0;
                let sumY = 0;
                const count = end - start + 1;
                
                for (let j = start; j <= end; j++) {
                    sumX += data[j].x;
                    sumY += data[j].y;
                }
                
                smoothed.push({
                    t: data[i].t,
                    x: sumX / count,
                    y: sumY / count
                });
            }
            
            appData.smoothedData = smoothed;
            
            // 更新图表
            updateCharts(windowSize);
            
            // 显示统计信息
            showStatistics(windowSize, data, smoothed);
            
            // 显示下载按钮
            document.getElementById('downloadRawBtn').classList.remove('hidden');
            document.getElementById('downloadSmoothedBtn').classList.remove('hidden');
            
            showNotification(`轨迹平滑完成，使用窗口大小: ${windowSize}`);
        }

        // 更新所有图表
        function updateCharts(windowSize) {
            // 隐藏无数据状态，显示图表
            document.getElementById('noDataState').classList.add('hidden');
            document.getElementById('trajectoryChart').classList.remove('hidden');
            document.getElementById('noXDataState').classList.add('hidden');
            document.getElementById('xTimeSeriesChart').classList.remove('hidden');
            document.getElementById('noYDataState').classList.add('hidden');
            document.getElementById('yTimeSeriesChart').classList.remove('hidden');
            
            // 显示统计面板
            document.getElementById('smoothStats').classList.remove('hidden');
            
            // 绘制轨迹对比图
            drawTrajectoryChart();
            
            // 绘制X轴时间序列图
            drawXTimeSeriesChart();
            
            // 绘制Y轴时间序列图
            drawYTimeSeriesChart();
        }

        // 绘制轨迹对比图
        function drawTrajectoryChart() {
            const ctx = document.getElementById('trajectoryChart').getContext('2d');
            
            // 如果已有图表实例，先销毁
            if (appData.trajectoryChart) {
                appData.trajectoryChart.destroy();
            }
            
            appData.trajectoryChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        // 原始轨迹线
                        {
                            label: '原始轨迹',
                            data: appData.originalData.map(p => ({ x: p.x, y: p.y })),
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            showLine: true,
                            tension: 0.1,
                            order: 1
                        },
                        // 平滑轨迹线
                        {
                            label: '平滑轨迹',
                            data: appData.smoothedData.map(p => ({ x: p.x, y: p.y })),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            showLine: true,
                            tension: 0.1,
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const originalPoint = appData.originalData[index];
                                    const smoothedPoint = appData.smoothedData[index];
                                    
                                    return [
                                        `时间: ${originalPoint.t.toFixed(1)}`,
                                        `原始: (${originalPoint.x.toFixed(2)}, ${originalPoint.y.toFixed(2)})`,
                                        `平滑: (${smoothedPoint.x.toFixed(2)}, ${smoothedPoint.y.toFixed(2)})`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'X 坐标'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Y 坐标'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // 绘制X轴时间序列图
        function drawXTimeSeriesChart() {
            const ctx = document.getElementById('xTimeSeriesChart').getContext('2d');
            
            if (appData.xTimeSeriesChart) {
                appData.xTimeSeriesChart.destroy();
            }
            
            appData.xTimeSeriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appData.originalData.map(p => p.t.toFixed(1)),
                    datasets: [
                        {
                            label: '原始X坐标',
                            data: appData.originalData.map(p => p.x),
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '平滑X坐标',
                            data: appData.smoothedData.map(p => p.x),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'X 坐标值'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // 绘制Y轴时间序列图
        function drawYTimeSeriesChart() {
            const ctx = document.getElementById('yTimeSeriesChart').getContext('2d');
            
            if (appData.yTimeSeriesChart) {
                appData.yTimeSeriesChart.destroy();
            }
            
            appData.yTimeSeriesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: appData.originalData.map(p => p.t.toFixed(1)),
                    datasets: [
                        {
                            label: '原始Y坐标',
                            data: appData.originalData.map(p => p.y),
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: '平滑Y坐标',
                            data: appData.smoothedData.map(p => p.y),
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            pointRadius: 2,
                            tension: 0.1,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Y 坐标值'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // 显示统计信息
        function showStatistics(windowSize, originalData, smoothedData) {
            // 计算平滑度 (1 - 平滑后数据变化量/原始数据变化量)
            let originalXVariance = 0;
            let smoothedXVariance = 0;
            let originalYVariance = 0;
            let smoothedYVariance = 0;
            
            for (let i = 1; i < originalData.length; i++) {
                // X方向变化
                originalXVariance += Math.abs(originalData[i].x - originalData[i-1].x);
                smoothedXVariance += Math.abs(smoothedData[i].x - smoothedData[i-1].x);
                
                // Y方向变化
                originalYVariance += Math.abs(originalData[i].y - originalData[i-1].y);
                smoothedYVariance += Math.abs(smoothedData[i].y - smoothedData[i-1].y);
            }
            
            // 计算平滑度百分比
            const xSmoothness = originalXVariance > 0 
                ? (1 - smoothedXVariance / originalXVariance) * 100 
                : 0;
                
            const ySmoothness = originalYVariance > 0 
                ? (1 - smoothedYVariance / originalYVariance) * 100 
                : 0;
            
            // 更新统计面板
            document.getElementById('totalPoints').textContent = originalData.length;
            document.getElementById('usedWindowSize').textContent = windowSize;
            document.getElementById('xSmoothness').textContent = xSmoothness.toFixed(2) + '%';
            document.getElementById('ySmoothness').textContent = ySmoothness.toFixed(2) + '%';
        }

        // 下载数据
        function downloadData(data, filename) {
            if (!data || data.length === 0) return;
            
            let csv = 't,x,y\n';
            data.forEach(point => {
                csv += `${point.t.toFixed(2)},${point.x.toFixed(6)},${point.y.toFixed(6)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`${filename} 已下载`);
        }

        // 下载数据模板
        function downloadTemplate() {
            let csv = 't,x,y\n';
            // 生成示例模板数据
            let t = 0;
            for (let i = 0; i < 20; i++) {
                t += 1;
                const x = Math.sin(i * 0.5) * 10;
                const y = Math.cos(i * 0.5) * 10;
                csv += `${t},${x.toFixed(4)},${y.toFixed(4)}\n`;
            }
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', '轨迹数据模板.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('数据模板已下载');
        }

        // 重置数据
        function resetData() {
            appData.originalData = null;
            appData.smoothedData = null;
            resetCharts();
            
            document.getElementById('downloadRawBtn').classList.add('hidden');
            document.getElementById('downloadSmoothedBtn').classList.add('hidden');
            document.getElementById('smoothStats').classList.add('hidden');
        }

        // 重置图表
        function resetCharts() {
            // 显示无数据状态
            document.getElementById('noDataState').classList.remove('hidden');
            document.getElementById('trajectoryChart').classList.add('hidden');
            document.getElementById('noXDataState').classList.remove('hidden');
            document.getElementById('xTimeSeriesChart').classList.add('hidden');
            document.getElementById('noYDataState').classList.remove('hidden');
            document.getElementById('yTimeSeriesChart').classList.add('hidden');
            
            // 销毁图表实例
            if (appData.trajectoryChart) {
                appData.trajectoryChart.destroy();
                appData.trajectoryChart = null;
            }
            
            if (appData.xTimeSeriesChart) {
                appData.xTimeSeriesChart.destroy();
                appData.xTimeSeriesChart = null;
            }
            
            if (appData.yTimeSeriesChart) {
                appData.yTimeSeriesChart.destroy();
                appData.yTimeSeriesChart = null;
            }
        }

        // 显示通知
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            icon.className = isError 
                ? 'fa fa-exclamation-circle text-red-500 mr-2' 
                : 'fa fa-check-circle text-green-500 mr-2';
            
            notification.className = `fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300 flex items-center z-50 ${
                isError ? 'bg-red-50 text-red-700 border border-red-200' : 'bg-green-50 text-green-700 border border-green-200'
            }`;
            
            // 3秒后隐藏
            setTimeout(() => {
                notification.className = 'fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50';
            }, 3000);
        }
    </script>
</body>
</html>
    
